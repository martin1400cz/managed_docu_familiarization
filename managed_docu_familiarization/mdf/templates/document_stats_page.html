{% extends 'layout/_grid.html' %}
{% load static i18n user_tags %}

{% block title %}- MDF base template for users{% endblock title %}

{% block css %}
{% endblock css %}

{% block javascript %}
{% endblock javascript %}


{% block inline_javascript %}
  {% include 'part/datatables.html' with datatables_element_id='mdf_document_stats_table' search_panes_columns='[1]' fixed_columns='1' %}
{% endblock inline_javascript %}

{% block content %}

<div class="container-fluid mb-4">

  <div>
    <h2>Document stats:</h2>
    <p>Document name: {{ document.doc_name }}</p>
    <p>Document url: {{ document.doc_url }}</p>
    <p>Release date: {{ document.release_date }}</p>
    <p>Document owner: {{ document.owner.zf_id }}</p>
    <p>Other responsible users:</p>
    {% for user in responsible_users %}
      <p>{{ user.zf_id }}</p>
    {% endfor %}
    <p>Category: {{ document.category }}</p>
    <p>Number of agreements: {{ agreements_count }}/{{ users_count }}</p>
  </div>

  {% if document.category == 3 %}
    <table aria-describedby="Overview of the Document"
               id="mdf_document_stats_table"
               class="table overview-datatable">
      <thead>
          <tr>
              <th>User</th>
              <th>Status</th>
              <th>Date of agreement</th>
              <th>Reading time</th>
              <th>Number of views</th>
              <td>Action</td>
          </tr>
      </thead>
      <tbody>
          {% for agreement in agreements_list %}
          <tr>
              <td>{{ agreement.user.zf_id }}</td>
              <td>{{ agreement.status }}</td>
              <td>{{ agreement.agreed_at }}</td>
              <td>{{ agreement.reading_time }} s</td>
              <td>{{ agreement.open_count }}</td>
              {% if agreement.agreed_at == '-' %}
                <td>
                 <button class="btn btn-primary" onclick="sendEmail('{{ agreement.user.zf_id }}', '{{ document.doc_id }}')">Send notification</button>
                </td>
              {% else %}
                <td> - </td>
              {% endif %}
          </tr>
          {% endfor %}
      </tbody>
    </table>
  {% endif %}
  <div>
    <a href="{% url 'mdf:base_page' %}">Back to the list of documents</a>
  </div>
</div>


<script>
function sendEmail(userId, documentId) {

    data = JSON.stringify({
        user_id: userId,
        document_id: documentId
    })


    let response = fetch(`/mdf/mdfdocuments/agreements/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}', // Django CSRF token
            'Content-Type': 'application/json'
        },
        body: data,
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json(); // Předpokládáme, že server vrací JSON
    })
    .then(data => {
        console.log("Server response:", data);
        if (data.status === 'success') {
            alert("Email was successfully sent.");
        } else {
            alert("Error: " + data.message);
        }
    })
    .catch(error => {
        console.error("Error during email notification:", error);
        alert("An error occurred while sending the email.");
    });
}
</script>
{% endblock content %}

