{% extends 'layout/_grid.html' %}
{% load static %}

{% block title %}- MDF base template for users{% endblock title %}

{% block css %}
    <style>
        .container {
            display: flex;
            gap: 20px;
        }
        .list-container {
            width: 300px;
        }
        .list {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
        }
    </style>
{% endblock css %}

{% block content %}


<div class="container my-4">
  <h2 class="mb-4">Add a New Document</h2>
  <form method="post" action="{% url 'mdf:publishing_page' %}">
    {% csrf_token %}
    {{ form.media }}
    <div class="mb-3">
      <label for="document_div" class="form-label">Document Info:</label>
      <div id="document_div">
        {{ form.name.label_tag }} {{ form.name }}
        {{ form.url.label_tag }} {{ form.url }}
      </div>
    </div>

    <div class="mb-3">
      <label for="contact_user_div" class="form-label">Contact users:</label>
      <div id="contact_user_div">
        {{ form.contact_users.label_tag }} {{ form.contact_users }}
      </div>
    </div>

    <!--<div class="row">
      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Dostupní uživatelé</h5>
          </div>
          <div class="card-body">
            <input
              type="text"
              id="userSearch"
              class="form-control search-input"
              placeholder="Hledat uživatele..."
            >
            <div class="list" id="availableUsers">
              {% for user in available_users %}
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm d-block w-100 text-start my-1"
                  data-user-id="{{ user.id }}"
                  data-user-name="{{ user.full_name }}"
                  data-user-email="{{ user.email }}"
                >
                  {{ user.full_name }} - ({{ user.email }})
                </button>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Vybraní uživatelé</h5>
          </div>
          <div class="card-body">
            <div class="list" id="selectedUsers">
            </div>
          </div>
        </div>
      </div>
    </div>-->

    <!-- Skryté pole pro odeslání dat -->
    <!--<input type="hidden" name="contact_users" id="contactUsersInput">-->
    <div class="mb-4">
      <!-- Kategorie -->
      {{ form.category.label_tag }} {{ form.category }}
    </div>
    <div id="deadline-selection" class="mb-4" style="display: none;">
      {{ form.deadline.label_tag }} {{ form.deadline }}
    </div>
    <div id="group-selection" class="mb-4" style="display: none;">
      {{ form.groups.label_tag }} {{ form.groups }}
    </div>
    <div class="text-center mb-4">
      <button type="submit" class="btn btn-success mt-3">Add Document</button>
    </div>
  </form>
</div>

    <script src="{% static 'admin/js/core.js' %}"></script>
    <script src="{% static 'admin/js/SelectBox.js' %}"></script>
    <script src="{% static 'admin/js/SelectFilter2.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/widgets.css' %}">
    <!--
    <script>
        const userSearch = document.getElementById('userSearch');
        const availableUsers = document.getElementById('availableUsers');
        const selectedUsers = document.getElementById('selectedUsers');
        const contactUsersInput = document.getElementById('contactUsersInput');

        // Filtrování dostupných uživatelů
        userSearch.addEventListener('input', function() {
            const filter = userSearch.value.toLowerCase();
            Array.from(availableUsers.querySelectorAll('button')).forEach(button => {
                const text = button.textContent.toLowerCase();
                button.style.display = text.includes(filter) ? '' : 'none';
            });
        });

        // Přidání uživatele do vybraných
        availableUsers.addEventListener('click', function(event) {
            if (event.target.tagName === 'BUTTON') {
                const button = event.target;
                const userId = button.dataset.userId;
                const userName = button.dataset.userName;
                const userEmail = button.dataset.userEmail
                //const userZfId = button.dataset.userZfId;

                // Přidání uživatele do vybraných
                const selectedButton = document.createElement('button');
                selectedButton.type = 'button';
                selectedButton.dataset.userId = userId;
                //selectedButton.dataset.userZfId = userZfId;
                selectedButton.dataset.userName = userName;
                selectedButton.dataset.userEmail = userEmail;
                //selectedButton.textContent = `${userZfId} - ${userName}`;
                selectedButton.textContent = `${userName} - ${userEmail}`;
                selectedUsers.appendChild(selectedButton);

                // Odebrání uživatele z dostupných
                button.remove();

                // Aktualizace skrytého pole
                updateHiddenField();
            }
        });

        // Odebrání uživatele z vybraných
        selectedUsers.addEventListener('click', function(event) {
            if (event.target.tagName === 'BUTTON') {
                const button = event.target;
                const userId = button.dataset.userId;
                const userName = button.dataset.userName;
                //const userZfId = button.dataset.userZfId;
                const userEmail = button.dataset.userEmail;

                // Přidání zpět do dostupných
                const availableButton = document.createElement('button');
                availableButton.type = 'button';
                availableButton.dataset.userId = userId;
                //availableButton.dataset.userZfId = userZfId;
                availableButton.dataset.userName = userName;
                availableButton.dataset.userEmail = userEmail;
                //availableButton.textContent = `${userZfId} - ${userName}`;
                availableButton.textContent = `${userName} - ${userEmail}`;
                availableUsers.appendChild(availableButton);

                // Odebrání z vybraných
                button.remove();

                // Aktualizace skrytého pole
                updateHiddenField();
            }
        });

        // Aktualizace skrytého pole
        function updateHiddenField() {
            const selectedIds = Array.from(selectedUsers.querySelectorAll('button')).map(button => button.dataset.userId);
            contactUsersInput.value = selectedIds;
        }
        /*function updateHiddenField() {
          const selectedIds = Array.from(selectedUsers.querySelectorAll('button')).map(button => button.dataset.userId);

          // Odstranění starých hodnot a nastavení nových
          //contactUsersInput.value = ''; // Vyprázdníme skryté pole (pro starý způsob)
          contactUsersInput.value = selectedIds[0];
          selectedIds.forEach(id => {
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "contact_users"; // Každá hodnota jako samostatný input
            hiddenInput.value = id;
            contactUsersInput.parentNode.appendChild(hiddenInput);
          });
        }*/
    </script>-->
    <script type="text/javascript">
        // Initialize the FilteredSelectMultiple widget on page load
        //window.addEventListener('load', function()
        document.addEventListener('DOMContentLoaded', function(){
            const groupSelectElement = document.getElementById("id_groups");
            const contactUserSelectElement = document.getElementById("id_users");
            if (groupSelectElement) {
                SelectFilter.init("id_groups", "Groups", 0);
            }
            if (contactUserSelectElement) {
                SelectFilter.init("id_users", "Users", 0);
            }
        });

        // JavaScript to show/hide the group selection based on category choice
        document.addEventListener('DOMContentLoaded', function() {
            // Get radio buttons and the group-selection div
            const categoryChoices = document.querySelectorAll('.category-choice input');
            const groupSelection = document.getElementById('group-selection');
            const deadlineSelection = document.getElementById('deadline-selection');

            // Function to toggle the visibility of the group-selection div
            function toggleGroupSelection() {
                const selectedCategory = document.querySelector('.category-choice input:checked');
                if (selectedCategory && (selectedCategory.value === '2' || selectedCategory.value === '3')) {
                    groupSelection.style.display = 'block';
                    if (selectedCategory.value === '3') {
                        deadlineSelection.style.display = 'block';
                    } else {
                        deadlineSelection.style.display = 'none';
                    }
                } else {
                    groupSelection.style.display = 'none';
                    deadlineSelection.style.display = 'none';
                }
            }

            // Attach event listeners to each radio button
            categoryChoices.forEach(choice => choice.addEventListener('change', toggleGroupSelection));

            // Initialize visibility based on the current selection
            toggleGroupSelection();
        });
    </script>


{% endblock content %}
