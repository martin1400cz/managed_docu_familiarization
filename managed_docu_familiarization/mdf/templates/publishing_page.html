{% extends 'layout/_grid.html' %}
{% load static %}

{% block title %}- MDF base template for users{% endblock title %}

{% block css %}
    <style>
        .container {
            display: flex;
            gap: 20px;
        }
        .list-container {
            width: 300px;
        }
        .list {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
        }
    </style>
{% endblock css %}

{% block content %}
<div class="container">
  <h2>Add a New Document</h2>
    <form method="post" action="{% url 'mdf:publishing_page' %}">
        <label for="document_div">Document info:</label>
        <div id="document_div">
            {% csrf_token %}
            {{ form.media }}
            <!-- Render the name field -->
            {{ form.name.label_tag }} {{ form.name }}
            {{ form.url.label_tag }} {{ form.url }}
            <div class="container">
            <!-- Dostupní uživatelé -->
            <div class="list-container">
                <h3>Dostupní uživatelé</h3>
                <input type="text" id="userSearch" placeholder="Hledat uživatele..." style="width: 100%; margin-bottom: 10px;">
                <div class="list" id="availableUsers">
                    {% for user in form.fields.contact_users.queryset %}
                        <button type="button" data-user-id="{{ user.id }}" data-user-name="{{ user.full_name }}" data-user-email="{{ user.email }}">
                            {{ user.full_name }} - ({{ user.email }})
                        </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Vybraní uživatelé -->
            <div class="list-container">
                <h3>Vybraní uživatelé</h3>
                <div class="list" id="selectedUsers">
                    <!-- Dynamicky přidávaní uživatelé -->
                </div>
            </div>
        </div>

        <!-- Skryté pole pro odeslání dat -->
        <input type="hidden" name="contact_users" id="contactUsersInput">
            <!-- Render the category radio buttons -->
            <div>
                {{ form.category.label_tag }}
                {{ form.category }}
            </div>

            <!-- Render the group selection, initially hidden -->
            <div id="group-selection" style="display: none;">
                {{ form.groups.label_tag }}
                {{ form.groups }}
            </div>
            <button type="submit">Add Document</button>

        </div>
    </form>

    <script src="{% static 'admin/js/core.js' %}"></script>
    <script src="{% static 'admin/js/SelectBox.js' %}"></script>
    <script src="{% static 'admin/js/SelectFilter2.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/widgets.css' %}">
    <script>
        const userSearch = document.getElementById('userSearch');
        const availableUsers = document.getElementById('availableUsers');
        const selectedUsers = document.getElementById('selectedUsers');
        const contactUsersInput = document.getElementById('contactUsersInput');

        // Filtrování dostupných uživatelů
        userSearch.addEventListener('input', function() {
            const filter = userSearch.value.toLowerCase();
            Array.from(availableUsers.querySelectorAll('button')).forEach(button => {
                const text = button.textContent.toLowerCase();
                button.style.display = text.includes(filter) ? '' : 'none';
            });
        });

        // Přidání uživatele do vybraných
        availableUsers.addEventListener('click', function(event) {
            if (event.target.tagName === 'BUTTON') {
                const button = event.target;
                const userId = button.dataset.userId;
                const userName = button.dataset.userName;
                const userEmail = button.dataset.userEmail
                //const userZfId = button.dataset.userZfId;

                // Přidání uživatele do vybraných
                const selectedButton = document.createElement('button');
                selectedButton.type = 'button';
                selectedButton.dataset.userId = userId;
                //selectedButton.dataset.userZfId = userZfId;
                selectedButton.dataset.userName = userName;
                selectedButton.dataset.userEmail = userEmail;
                //selectedButton.textContent = `${userZfId} - ${userName}`;
                selectedButton.textContent = `${userName} - ${userEmail}`;
                selectedUsers.appendChild(selectedButton);

                // Odebrání uživatele z dostupných
                button.remove();

                // Aktualizace skrytého pole
                updateHiddenField();
            }
        });

        // Odebrání uživatele z vybraných
        selectedUsers.addEventListener('click', function(event) {
            if (event.target.tagName === 'BUTTON') {
                const button = event.target;
                const userId = button.dataset.userId;
                const userName = button.dataset.userName;
                //const userZfId = button.dataset.userZfId;
                const userEmail = button.dataset.userEmail;

                // Přidání zpět do dostupných
                const availableButton = document.createElement('button');
                availableButton.type = 'button';
                availableButton.dataset.userId = userId;
                //availableButton.dataset.userZfId = userZfId;
                availableButton.dataset.userName = userName;
                availableButton.dataset.userEmail = userEmail;
                //availableButton.textContent = `${userZfId} - ${userName}`;
                availableButton.textContent = `${userName} - ${userEmail}`;
                availableUsers.appendChild(availableButton);

                // Odebrání z vybraných
                button.remove();

                // Aktualizace skrytého pole
                updateHiddenField();
            }
        });

        // Aktualizace skrytého pole
        function updateHiddenField() {
            const selectedIds = Array.from(selectedUsers.querySelectorAll('button')).map(button => button.dataset.userId);
            contactUsersInput.value = selectedIds.join(',');
        }
    </script>
    <script type="text/javascript">
        // Initialize the FilteredSelectMultiple widget on page load
        //window.addEventListener('load', function()
        document.addEventListener('DOMContentLoaded', function(){
            const groupSelectElement = document.getElementById("id_groups");
            if (groupSelectElement) {
                SelectFilter.init("id_groups", "Groups", 0);
            }
        });

        // JavaScript to show/hide the group selection based on category choice
        document.addEventListener('DOMContentLoaded', function() {
            // Get radio buttons and the group-selection div
            const categoryChoices = document.querySelectorAll('.category-choice input');
            const groupSelection = document.getElementById('group-selection');

            // Function to toggle the visibility of the group-selection div
            function toggleGroupSelection() {
                const selectedCategory = document.querySelector('.category-choice input:checked');
                if (selectedCategory && (selectedCategory.value === '2' || selectedCategory.value === '3')) {
                    groupSelection.style.display = 'block';
                } else {
                    groupSelection.style.display = 'none';
                }
            }

            // Attach event listeners to each radio button
            categoryChoices.forEach(choice => choice.addEventListener('change', toggleGroupSelection));

            // Initialize visibility based on the current selection
            toggleGroupSelection();
        });
    </script>

</div>
{% endblock content %}
